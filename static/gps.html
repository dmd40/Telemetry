<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="/static/css/styles.css">
  <title>GPS Trajectory</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <div class="nav">
    <div class="nav-left">
      <div class="nav-dropdown">
        <button id="navToggle" class="nav-dropdown-toggle">
          VOID Telemetry <span class="nav-caret">â–¾</span>
        </button>
        <div id="navMenu" class="nav-dropdown-menu">
          <a href="/static/index.html">Live</a>
          <a href="/static/lap.html">Lap Plot</a>
          <a href="/static/gps.html">GPS</a>
          <button id="simBtn" class="nav-sim-btn">Start Simulation</button>
        </div>
      </div>
    </div>
    <div class="nav-right">
      <img src="/static/logo2.png" alt="VOID Telemetry logo" class="logo-img" />
    </div>
  </div>

  <div class="page">
    <h1>Vehicle GPS Trajectory</h1>

    <div class="row">
      <button id="latestBtn">Show Latest Lap</button>

      <label for="lapSel">Lap:</label>
      <select id="lapSel"></select>
      <button id="showBtn">Show Selected</button>
    </div>

    <div id="map"></div>
  </div>

  <script>
    const map = L.map('map').setView([37.42, -122.08], 17);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20 }).addTo(map);

    let poly;
    let simulationRunning = false;

    async function loadLaps() {
      const res = await fetch("/api/laps");
      const j = await res.json();
      const laps = j.laps || [0];
      const latest = j.latest ?? (laps.length ? laps[laps.length-1] : 0);

      const sel = document.getElementById("lapSel");
      sel.innerHTML = "";
      laps.forEach(l => {
        const opt = document.createElement("option");
        opt.value = l; opt.textContent = l;
        if (l === latest) opt.selected = true;
        sel.appendChild(opt);
      });
      return latest;
    }

    async function showLap(lapId) {
      const res = await fetch(`/api/lap/${lapId}/gps`);
      const j = await res.json();
      const pts = (j.points || [])
        .filter(p => p.lat !== null && p.lon !== null)
        .map(p => [p.lat, p.lon]);

      if (!pts.length) return;

      if (poly) map.removeLayer(poly);
      poly = L.polyline(pts, { }).addTo(map);
      map.fitBounds(poly.getBounds(), { padding: [20,20] });
      map.fitBoun
    }

    document.getElementById("latestBtn").onclick = async () => {
      const res = await fetch("/api/laps");
      const j = await res.json();
      await showLap(j.latest ?? 0);
    };

    document.getElementById("showBtn").onclick = async () => {
      const lapId = Number(document.getElementById("lapSel").value);
      await showLap(lapId);
    };

    const simBtn = document.getElementById("simBtn");
    const navToggle = document.getElementById("navToggle");
    const navMenu = document.getElementById("navMenu");
    
    async function updateSimulationStatus() {
      const res = await fetch("/api/simulation/status");
      const j = await res.json();
      simulationRunning = j.running;
      simBtn.textContent = simulationRunning ? "Stop Simulation" : "Start Simulation";
      simBtn.textContent = simulationRunning ? "Stop Simulation" : "Start Simulation";
      simBtn.classList.toggle("active", simulationRunning);
    }

    simBtn.onclick = async () => {
      if (simulationRunning) {
        await fetch("/api/simulation/stop", { method: "POST" });
      } else {
        await fetch("/api/simulation/start", { method: "POST" });
      }
      await updateSimulationStatus();
      await loadLaps();
    };

    navToggle.addEventListener("click", (event) => {
      event.stopPropagation();
      navMenu.classList.toggle("open");
    });

    document.addEventListener("click", (event) => {
      if (!navMenu.classList.contains("open")) return;
      if (navMenu.contains(event.target) || navToggle.contains(event.target)) return;
      navMenu.classList.remove("open");
    });

    (async () => {
      await updateSimulationStatus();
      const latest = await loadLaps();
      await showLap(latest);
    })();
  </script>
</body>
</html>
